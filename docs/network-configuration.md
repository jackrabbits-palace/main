# Network Configuration
i wanna let the internet talk to servers on my raspberry pi. How do i go about doing this?

according to some resources, here are the general steps:
1. assign a static ip address to the pi on the local network
2. update the configuration of your router to port forward inbound traffic to your pi
3. setup ddns

*for most of these steps, i am assuming we are running at least raspbian stretch.*

# assign static ip address to your pi
the raspberry pi defaults to using a dynamic IP address assigned by the DHCP server (most likely your network router). we want to set it to be static instead.
### network information
we need to learn a bit about our network before we do anything.

1. get the **default gateway ip**. this is the local ip address of our router. all connected devices talk to this in order to access the internet or other devices connected on the local network.
   ```shell
   $ netstat -nr
   Kernel IP routing table
   Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
   0.0.0.0         192.168.66.1    0.0.0.0         UG        0 0          0 wlan0
   192.168.66.0    0.0.0.0         255.255.255.0   U         0 0          0 wlan0
   ```
   we can see that `192.168.66.1` is our *gateway ip*.

   alternately, get the same information in one command with:

   ```shell
   $ netstat -nr | sed -n 3p | awk '{print $2}'
   192.168.66.1
   ```
2. get the **DNS server ip**. this is most likely the same as the gateway ip since your router might be acting as your DNS server.
   ```shell
   $ cat /etc/resolv.conf
   # Generated by resolvconf
   nameserver 192.168.66.1
   ```
   alternately, get the same information in one command with:
   ``` shell
   grep nameserver /etc/resolv.conf | awk '{print $2}'
   ```

3. get our pi's **local ip** address and broadcast address:
   ```shell
   $ ip -a addr show | grep global
   inet 192.168.66.145/24 brd 192.168.66.255 scope global wlan0
   ```
   alternately, get the same information in one command with:
   ```shell
   ip -a addr show | grep global | awk '{print $2}'
   ```

### update dhcpcd.conf
we need to now tell the dhcp server that we don't want a dynamic ip address, but we will be using a static one. we can do this by making some updates to the `/etc/dhcpcd.conf` file. this file is the configuration for the dhcp client daemon which runs on our pi and communicates with the dhcp server. Here are the changes we need to make to `/etc/dhcpcd.conf`:
```shell
interface wlan0
static ip_address=192.168.66.145/24
static routers=192.168.66.1
static domain_name_servers=192.168.66.1
```
in the changes above, we are using the info we gathered previously and mapped
* *ip_address* <--> *local ip*
* *routers* <--> *gateway ip*
* *domain_name_servers* <--> *DNS server ip*

### reboot your pi
# update router config to port forward inbound trafic to pi
now we need to configure our router to port forward a port on the router's public ip to a port on our pi's static local network ip. to do this we need to login to our router's admin portal. go to your web browser and go to your router ip. In the previous step we found that the router (gateway) ip is `192.168.66.1`, so lets go there in our browser. You should be presented with the login screen for your router. Usually the username and password are both `admin` so you should probably change this to something more secure.

this step will be highly depenedent on what router you have. generally, you want to find a way to configure port forwarding and then forward a port on the router's public ip to a port on your pi's static local ip address using all protocols.

to test if this works, we can find the public ip address of our router and navigate in our browser (or curl),

``` shell
$ curl ipinfo.io/ip
59.202.50.187
```
we can then curl this ip and see if it works

``` shell
$ curl  59.202.50.187
<output of some server running on 80 on your box>
```

an example simple server could be setup as follows (but you do you):

``` shell
$ sudo su
# cd /var/www
# mkdir hello && cd hello
# echo "hi there freindos!" > index.html
# python3 -m http.server 80
```

# dynamic dns
just like how, by default, a device connecting onto the local network is dynamically assigned an ip address by your router, your *router* is dynamically re-assigned an ip address by your internet service provider (ISP) quite frequently. if we want to be able to connect to our router from the outside world (via a domain name we own or something) without having to always re-lookup our router's exposed ip address, then we are going to have to stay up-to-date with what our router's ip address everytime it changes. *Dynamic DNS* (DDNS) to the rescue!
### what is DDNS?
its basically an approach for your local computer to broadcast changes to its router's public ip address to some external service which wants to keep up-to-date with your ip address. There are a couple ways of going about this,
1. **your router has a DDNS client built into it**: your router detects when its public ip changes and then broadcasts this to a service which wants to know. the services that a router can broadcast to might be limited so, for example, if you have a domain registered with namecheap and your router doesn't broadcast to the namecheap ddns service, then you are out of luck.
2. **use a ddns service**: there are free online ddns service providers which will give you a domain name which will not change and sync to a ddns client daemon you run on your computer (or if your router can broadcast to that ddns service you can use the ddns client built into your router instead of running one on your computer) which will sync the changing public ip address of your router to the domain name that the ddns service provider has given you. if you already have a domain name (from namecheap for example) this means that you are registering for another intermediate domain name which is annoying. so this solution is just one more extra service to deal with.
3. **use a ddns client on your machine**: on linux there is a nice ddns client called [`ddclient`](https://github.com/ddclient/ddclient) which supports a bunch of ddns service providers including namecheap. since we can setup ddns with a domain name we've registered through namecheap, we will just use this.

### `ddclient`
here is a [useful blog post](https://blog.dembowski.net/2013/namecheap-dynamic-dns-setup-with-ddclient/) i read about setting up `ddclient` to work with namecheap ddns.
1. log into namecheap, go to domain list -> advanced dns -> add new record `A + Dynamic DNS Record`
2. set the `Host` to be `@` (the root domain (or `www` if you want this to point to `www.yourdomain.tld`)) and the `IP Address` to be some dummy address like `127.0.0.1` since our `ddclient` is going to overwrite this once it starts working.
3. still on namecheap, there should be an option to enable ddns, which you should do and then it will give you a long Dynamic DNS Password.
4. on your pi, install the `ddclient`
   ```shell
   $ sudo DEBIAN_FRONTEND=noninteractive apt install ddclient -yq
   ```
5. now edit the `/etc/ddclient.conf` on your pi to look something like
   ```shell
   # /etc/ddclient.conf

   #############
   # namecheap #
   #############
   use=web, web=dynamicdns.park-your-domain.com/getip
   ssl=yes
   protocol=namecheap
   server=dynamicdns.park-your-domain.com
   login=slime.church
   password='your namecheap ddns password'
   @.slime.church
   ```
6. restart ddclient
   ```shell
   $ sudo ddclient
   ```
7. configure `ddclient` to run as a daemon, open `/etc/default/ddclient`
   ```shell
   run_ipup="false
   run_daemon="true"
   ```
8. start the ddclient daemon, `sudo service ddclient start`

this is another [good blog post](https://samhobbs.co.uk/2015/01/dynamic-dns-ddclient-raspberry-pi-and-ubuntu) which says something at the end about dynamic dns providers timing out if there are no updates in a while, but i won't worry about that for now.
